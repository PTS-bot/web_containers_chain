worker_processes 1;

events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # ‡πÉ‡∏ä‡πâ DNS Docker (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ä‡∏∑‡πà‡∏≠ Container)
    resolver 127.0.0.11 valid=30s ipv6=off;

    server {
        listen 8080; # ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ 80 ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô Container

        # ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ü‡∏•‡πå HTML (Map ‡∏à‡∏≤‡∏Å ./web_porxy_nginx ‡πÉ‡∏ô docker-compose)
        root /usr/share/nginx/html;
        index index.html;

        # --------------------------------------------------------
        # 1. API Proxy (Backend Node.js)
        # --------------------------------------------------------
        location /api/ {
            # üî• ‡∏•‡∏ö rewrite ‡∏≠‡∏≠‡∏Å ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á /api/login ‡πÑ‡∏õ‡∏´‡∏≤ Node.js ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            proxy_pass http://auth-service:3000; 
            
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        # --------------------------------------------------------
        # 2. ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏•‡∏±‡∏Å (Login & Dashboard)
        # --------------------------------------------------------
        location / {
            # ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ï‡∏≤‡∏°‡∏ä‡∏∑‡πà‡∏≠ -> ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏õ index.html (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SPA)
            try_files $uri $uri/ /index.html;
        }

        # ‡∏´‡∏ô‡πâ‡∏≤ Error
        error_page 404 500 502 503 504 /error.html;
        location = /error.html {
            internal;
        }

        # --------------------------------------------------------
        # 3. Jupyter Proxy
        # --------------------------------------------------------
        location /jupyter/ {
            proxy_pass http://jupyter:8888;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
        }
        # --------------------------------------------------------
        # 3. Jupyter Proxy
        # --------------------------------------------------------
        location /jupyter2/ {
            proxy_pass http://jupyter2:8888;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
        }
        # --------------------------------------------------------
        # 4. Open WebUI Proxy
        # --------------------------------------------------------
        location /open-webui/ {
            proxy_pass http://open-webui:8080/;
            proxy_set_header Accept-Encoding ""; 

            # Sub Filters
            sub_filter_types *;
            sub_filter 'src="/static/splash.png"' 'src="/my-background.jpg"';
            sub_filter 'href="/' 'href="/open-webui/';
            sub_filter 'src="/' 'src="/open-webui/';
            sub_filter 'action="/' 'action="/open-webui/';
            sub_filter '"/api' '"/open-webui/api';
            sub_filter '"/static' '"/open-webui/static';
            sub_filter_once off;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
        }

        # --------------------------------------------------------
        # 5. Obsidian Proxy
        # --------------------------------------------------------
        location /obsidian/ {
            proxy_pass http://obsidian:3000/; 
            proxy_set_header Accept-Encoding ""; 

            sub_filter_types *;
            sub_filter 'href="/' 'href="/obsidian/';
            sub_filter 'src="/' 'src="/obsidian/';
            sub_filter 'action="/' 'action="/obsidian/';
            sub_filter '"/static/' '"/obsidian/static/';
            sub_filter '"/_next/' '"/obsidian/_next/';
            sub_filter_once off;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
        }

        # --------------------------------------------------------
        # 6. Whiteboard Proxy
        # --------------------------------------------------------
        location /White_board/ {
            proxy_pass http://White_board:8080/; # ‡πÅ‡∏Å‡πâ Port ‡πÄ‡∏õ‡πá‡∏ô 8080 ‡∏ï‡∏≤‡∏°‡∏õ‡∏Å‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á wbo docker ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πá‡∏Ñ docker-compose ‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ
            proxy_set_header Accept-Encoding ""; 

            sub_filter_types *;
            # ‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Path /White_board/
            sub_filter 'href="/' 'href="/White_board/';
            sub_filter 'src="/' 'src="/White_board/';
            sub_filter '/socket.io' '/White_board/socket.io';
            sub_filter_once off;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
        }

        # --------------------------------------------------------
        # 7. Dynamic Proxy (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ)
        # --------------------------------------------------------
        location ~ ^/proxy/(?<target_port>\d+)/(?<target_path>.*)$ {
            resolver 127.0.0.11;
            proxy_pass http://host.docker.internal:$target_port/$target_path$is_args$args;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_intercept_errors on;
        }
    }
}