<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Web Containers Chain</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* --- üåå BASIC STYLE --- */
        body, html { height: 100%; margin: 0; padding: 0; background-color: #000; font-family: 'Segoe UI', sans-serif; overflow-x: hidden; color: white; }
        .stars-small { width: 1px; height: 1px; background: transparent; position: absolute; box-shadow: 10vw 10vh #FFF, 50vw 50vh #FFF; opacity: 0.8; animation: starTwinkle 5s infinite alternate; }
        @keyframes starTwinkle { from { opacity: 0.3; } to { opacity: 1; } }

        /* Header */
        .header-bar { position: absolute; top: 20px; right: 40px; z-index: 100; display: flex; gap: 15px; align-items: center; background: rgba(0, 0, 0, 0.5); padding: 10px 20px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1); }
        .user-info { color: #00d2ff; font-weight: bold; }
        
        h1.main-title { color: #ffffff; font-size: 3em; font-weight: 300; text-align: center; margin-top: 100px; margin-bottom: 40px; text-shadow: 0 0 10px rgba(255,255,255,0.8); }

        /* Admin Panel */
        .admin-container { max-width: 1100px; margin: 0 auto; padding: 20px; position: relative; z-index: 20; display: none; }
        .glass-box { background: rgba(255, 255, 255, 0.07); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; padding: 25px; margin-bottom: 30px; }
        h2 { color: #00d2ff; margin-top: 0; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }

        /* Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; color: #ddd; table-layout: fixed; }
        th, td { border: 1px solid rgba(255,255,255,0.1); padding: 12px; text-align: left; vertical-align: middle; overflow: hidden; text-overflow: ellipsis; }
        th { background-color: rgba(0, 210, 255, 0.1); color: #00d2ff; text-transform: uppercase; font-size: 0.9em; }
        tr:nth-child(even) { background-color: rgba(255,255,255,0.02); }

        /* Columns */
        .col-username { width: 20%; } .col-role { width: 15%; } .col-group { width: 50%; } .col-action { width: 15%; text-align: center; } 
        
        /* Buttons */
        .btn { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; transition: 0.2s; font-weight: bold; font-size: 0.85em; }
        .btn:hover { transform: translateY(-2px); }
        .btn-success { background: #2ecc71; color: #000; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f1c40f; color: #000; }
        .btn-info { background: #3498db; color: white; }

        .role-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8em; color: #000; font-weight: bold; cursor: pointer; }
        .status-pending { background: #f1c40f; } .status-user { background: #2ecc71; } .status-admin { background: #9b59b6; color: white; } .status-superadmin { background: #e74c3c; color: white; }

        /* Toggle Button */
        .toggle-btn { border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.05); color: #aaa; padding: 5px 10px; margin: 3px; border-radius: 4px; cursor: pointer; font-size: 0.75em; display: inline-block; }
        .toggle-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .toggle-btn.active { background: #00d2ff !important; color: #000 !important; border-color: #00d2ff !important; font-weight: bold; box-shadow: 0 0 5px rgba(0,210,255,0.5); }

        .input-text { background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #1a1a1a; border: 1px solid #333; padding: 30px; border-radius: 10px; width: 350px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #aaa; }
        .form-group input, .form-group select { width: 100%; padding: 10px; background: #333; border: 1px solid #555; color: white; border-radius: 4px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="stars-small"></div>
    <div class="header-bar" id="headerBar" style="display:none;">
        <span class="user-info" id="displayUsername"></span>
        <button class="btn btn-warning" onclick="openChangePwdModal()">üîë Password</button>
        <button class="btn btn-danger" onclick="logout()">Logout</button>
    </div>

    <h1 class="main-title">web containers chain</h1>

    <div id="adminPanel" class="admin-container">
        <div class="glass-box">
            <h2>üë§ Users <div><button class="btn btn-success" onclick="openAddUserModal()">‚ûï Add User</button></div></h2>
            <table id="userTable">
                <thead><tr><th class="col-username">Username</th><th class="col-role">Role</th><th class="col-group">Groups</th><th class="col-action">Action</th></tr></thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>
        <div class="glass-box">
            <h2>üè¢ Groups <div><input type="text" id="newGroupName" class="input-text" placeholder="Name"><button onclick="createGroup()" class="btn btn-success" style="margin-left:5px;">+ Create</button></div></h2>
            <table id="groupTable">
                <thead><tr><th>Name</th><th>Permissions</th><th class="col-action">Action</th></tr></thead>
                <tbody id="groupTableBody"></tbody>
            </table>
        </div>
    </div>

    <div id="addUserModal" class="modal-overlay">
        <div class="modal-box">
            <h3>Add User</h3>
            <div class="form-group"><label>Username</label><input type="text" id="modalUsername"></div>
            <div class="form-group"><label>Password</label><input type="password" id="modalPassword"></div>
            <div class="form-group"><label>Initial Group</label><select id="modalGroupSelect"></select></div>
            <div class="modal-actions"><button class="btn btn-danger" onclick="closeModal('addUserModal')">Cancel</button><button class="btn btn-success" onclick="confirmAddUser()">Create</button></div>
        </div>
    </div>
    
    <div id="changePwdModal" class="modal-overlay"><div class="modal-box"><h3>Change Password</h3><div class="form-group"><label>Old Pwd</label><input type="password" id="oldPwd"></div><div class="form-group"><label>New Pwd</label><input type="password" id="newPwd"></div><div class="modal-actions"><button class="btn btn-danger" onclick="closeModal('changePwdModal')">Cancel</button><button class="btn btn-success" onclick="confirmChangePwd()">Update</button></div></div></div>
    <div id="resetPwdModal" class="modal-overlay"><div class="modal-box"><h3>Reset Password</h3><p id="resetTargetUser"></p><div class="form-group"><input type="text" id="adminNewPwd" placeholder="New Password"></div><div class="modal-actions"><button class="btn btn-danger" onclick="closeModal('resetPwdModal')">Cancel</button><button class="btn btn-success" onclick="confirmResetPwd()">Reset</button></div></div></div>

    <script>
        const appConfig = {
            menus: [
                { id: 'view_dashboard', name: 'Dashboard' },
                { id: 'manage_users', name: 'User Management' },
                { id: 'manage_groups', name: 'Group Management' },
                { id: 'view_reports', name: 'Reports' },
                { id: 'system_settings', name: 'Settings' }
            ]
        };

        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'superadmin')) {
            document.getElementById('headerBar').style.display = 'flex';
            document.getElementById('displayUsername').innerText = `üë§ ${currentUser.username}`;
            document.getElementById('adminPanel').style.display = 'block';
            loadData();
        } else {
             if (!currentUser) window.top.location.href = 'index.html';
        }

        let allUsers = [], allGroups = [], targetUserForReset = null;

        async function loadData() {
            try {
                const [u, g] = await Promise.all([fetch('/api/users?t='+Date.now()), fetch('/api/groups?t='+Date.now())]);
                allUsers = await u.json();
                allGroups = await g.json();
                renderUserTable();
                renderGroupTable();
            } catch (e) { alert("Cannot connect to server!"); console.error(e); }
        }

        function renderUserTable() {
            const tb = document.getElementById('userTableBody'); tb.innerHTML = '';
            allUsers.forEach(user => {
                const tr = document.createElement('tr');
                let displayRole = user.role === 'admin' ? 'admin' : (user.role === 'superadmin' ? 'superadmin' : (user.status === 'approved' ? 'user' : 'pending'));
                
                let groupsHtml = '';
                // Logic ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÄ‡∏ä‡πá‡∏Ñ Array 100%
                let uGroups = Array.isArray(user.groups) ? user.groups : [];
                allGroups.forEach(g => {
                    const active = uGroups.includes(g.name);
                    groupsHtml += `<button class="toggle-btn ${active?'active':''}" onclick="toggleUserGroup('${user.username}','${g.name}')">${g.name}</button> `;
                });

                tr.innerHTML = `
                    <td>${user.username}</td>
                    <td><span class="role-badge status-${displayRole}" onclick="cycleUserRole('${user.username}')">${displayRole.toUpperCase()}</span></td>
                    <td style="white-space:normal;">${groupsHtml || '<span style="color:#555">No Groups</span>'}</td>
                    <td class="col-action">
                        ${(user.role!=='superadmin' && user.username!==currentUser.username) ? 
                        `<button class="btn btn-danger" onclick="deleteUser('${user.username}')">Del</button>
                         ${currentUser.role==='superadmin' ? `<button class="btn btn-info" onclick="openResetPwd('${user.username}')">üîë</button>`:''}` 
                        : ''}
                    </td>`;
                tb.appendChild(tr);
            });
        }

        function renderGroupTable() {
            const tb = document.getElementById('groupTableBody'); tb.innerHTML = '';
            allGroups.forEach(g => {
                let permHtml = '';
                appConfig.menus.forEach(m => {
                    const active = (g.permissions||[]).includes(m.id);
                    permHtml += `<button class="toggle-btn ${active?'active':''}" onclick="toggleGroupPerm('${g.name}','${m.id}')">${m.name}</button> `;
                });
                // ‡∏õ‡∏∏‡πà‡∏° Del ‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ üëá
                tb.innerHTML += `<tr>
                    <td><b>üë• ${g.name}</b></td>
                    <td style="white-space:normal;">${permHtml}</td>
                    <td class="col-action"><button class="btn btn-danger" onclick="deleteGroup('${g.name}')">Del</button></td>
                </tr>`;
            });
        }

        // --- API Helper ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Error ---
        async function apiPost(url, data) {
            try {
                const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data)});
                const json = await res.json();
                if(!json.success) {
                    alert("‚ùå Error: " + (json.message || "Unknown error")); // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô
                    return false;
                }
                return true;
            } catch(e) {
                alert("‚ùå Connection Error");
                console.error(e);
                return false;
            }
        }

        async function toggleUserGroup(username, groupName) {
            const user = allUsers.find(u => u.username === username);
            let grps = Array.isArray(user.groups) ? [...user.groups] : [];
            if(grps.includes(groupName)) grps = grps.filter(g=>g!==groupName); else grps.push(groupName);
            if(await apiPost('/api/update-user', { username, groups: grps })) loadData();
        }

        async function createGroup() {
            const name = document.getElementById('newGroupName').value;
            if(!name) return alert("Please enter group name");
            if(await apiPost('/api/create-group', { name })) {
                document.getElementById('newGroupName').value = '';
                loadData();
            }
        }
        
        async function confirmAddUser() {
            const u = document.getElementById('modalUsername').value;
            const p = document.getElementById('modalPassword').value;
            const g = document.getElementById('modalGroupSelect').value;
            if(!u || !p) return alert("Fill username/password");
            
            if(await apiPost('/api/create-user', { username: u, password: p, group: g })) {
                closeModal('addUserModal'); 
                loadData();
            }
        }

        async function deleteUser(username) { if(confirm('Delete user?')) { if(await apiPost('/api/delete-user', { username })) loadData(); } }
        async function deleteGroup(name) { if(confirm('Delete group?')) { if(await apiPost('/api/delete-group', { name })) loadData(); } }
        async function cycleUserRole(username) { /* Logic ‡πÄ‡∏î‡∏¥‡∏° */ 
            const user = allUsers.find(u=>u.username===username);
            if(!user || user.role==='superadmin') return;
            let newRole='user', newStatus='approved';
            if(user.status==='approved' && user.role==='user') newRole='admin';
            else if(user.status==='approved' && user.role==='admin') { newRole='user'; newStatus='pending'; }
            if(await apiPost('/api/update-user', { username, role: newRole, status: newStatus })) loadData();
        }
        
        async function toggleGroupPerm(gName, mId) {
            const g = allGroups.find(x=>x.name===gName);
            let p = [...(g.permissions||[])];
            if(p.includes(mId)) p = p.filter(x=>x!==mId); else p.push(mId);
            if(await apiPost('/api/update-group', { name: gName, permissions: p })) loadData();
        }

        // Modals
        function openAddUserModal() { 
            document.getElementById('modalUsername').value=''; document.getElementById('modalPassword').value=''; 
            const sel = document.getElementById('modalGroupSelect'); sel.innerHTML='<option value="">-- None --</option>';
            allGroups.forEach(g=>sel.innerHTML+=`<option value="${g.name}">${g.name}</option>`);
            document.getElementById('addUserModal').style.display='flex'; 
        }
        function openResetPwd(u) { targetUserForReset=u; document.getElementById('resetTargetUser').innerText=u; document.getElementById('resetPwdModal').style.display='flex'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        // Password Ops omitted for brevity (same logic with apiPost check)
        async function confirmChangePwd() { 
            const oldP=document.getElementById('oldPwd').value, newP=document.getElementById('newPwd').value;
            if(await apiPost('/api/change-password', {username:currentUser.username, oldPassword:oldP, newPassword:newP})) { alert("Changed!"); closeModal('changePwdModal'); }
        }
        async function confirmResetPwd() {
            const newP=document.getElementById('adminNewPwd').value;
            if(await apiPost('/api/admin-reset-password', {targetUsername:targetUserForReset, newPassword:newP})) { alert("Reset Done!"); closeModal('resetPwdModal'); }
        }
        function logout() { sessionStorage.clear(); window.top.location.href='index.html'; }
    </script>
</body>
</html>