worker_processes 1;
events { worker_connections 1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

    # ‡πÉ‡∏ä‡πâ DNS Docker (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Dynamic)
    resolver 127.0.0.11 valid=10s ipv6=off;

    server {
        listen 8080;

        error_page 404 500 502 503 504 /error.html;
        # 2. ‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå /error.html ‡∏≠‡∏¢‡∏π‡πà‡∏ó‡∏µ‡πà‡πÑ‡∏´‡∏ô
        location = /error.html {
            root /var/www/dashboard; # path ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏ó‡∏µ‡πà‡∏ß‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå index.html
            internal; # ‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡∏ï‡∏£‡∏á‡πÜ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Å‡∏¥‡∏î error ‡∏ñ‡∏∂‡∏á‡∏à‡∏∞‡∏°‡∏≤
        }

        # 1. ‡∏´‡∏ô‡πâ‡∏≤ Dashboard (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏°)
        location / {
            root /var/www/dashboard;
            index index.html;
            try_files $uri $uri/ /index.html;
        }

        # 2. Block ‡∏°‡∏´‡∏±‡∏®‡∏à‡∏£‡∏£‡∏¢‡πå (Dynamic Proxy)
        # ‡∏à‡∏±‡∏ö Pattern: /proxy/<‡πÄ‡∏•‡∏Ç‡∏û‡∏≠‡∏£‡πå‡∏ï>/<path‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠>
# nginx.conf

# ----------------------------- Block ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Jupyter (‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£‡∏Å‡∏ß‡πà‡∏≤ Regex) -------------------------------
        location /jupyter/ {
            # ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà 127.0.0.1:8888/jupyter/ (Path ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß)
            proxy_pass http://jupyter:8888;
            
            # --- üî• WebSocket Support (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Jupyter) üî• ---
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            
            # Header ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            
            # ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ Refused to connect (‡∏•‡∏ö Header ‡∏´‡πâ‡∏≤‡∏° iframe)
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
        }


# -----------------------------------------------------------------------------------
# ---------------------------------- Block ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö open-webui -----------------------------------
location /open-webui/ {
        # 1. ‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏ó‡∏µ‡πà Container
        proxy_pass http://open-webui:8080/;

        # 2. ‡∏´‡πâ‡∏≤‡∏°‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡πÑ‡∏°‡πà‡∏á‡∏±‡πâ‡∏ô‡πÅ‡∏Å‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ)
        proxy_set_header Accept-Encoding ""; 

        # =========================================================
        # üñºÔ∏è ‡πÇ‡∏ã‡∏ô‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (UI Patching) - ‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢
        # =========================================================
        # ‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏õ Inspect ‡∏î‡∏π‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∞‡πÑ‡∏£
        # (‡∏õ‡∏Å‡∏ï‡∏¥ Open WebUI ‡∏°‡∏±‡∏Å‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠ splash.png ‡∏´‡∏£‡∏∑‡∏≠ favicon.png)
        
        # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ Splash Screen ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
        sub_filter 'src="/static/splash.png"' 'src="/my-background.jpg"';
        sub_filter 'src="/static/favicon.png"' 'src="/my-logo.png"';
        
        # ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Logo (‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô‡πÄ‡∏õ‡πá‡∏ô SVG ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÅ‡∏Å‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏¥‡∏ò‡∏µ‡∏ô‡∏µ‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏π Source Code)
        sub_filter 'src="/static/logo.svg"' 'src="/my-logo.png"';

        # =========================================================
        # üî• ‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÅ‡∏Å‡πâ Link ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Path Fix) üî•
        # =========================================================
        sub_filter_types *; 
        
        # ‡πÅ‡∏Å‡πâ Root Path (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏ß‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
        sub_filter 'href="/' 'href="/open-webui/';
        sub_filter 'src="/' 'src="/open-webui/';
        sub_filter 'action="/' 'action="/open-webui/';
        
        sub_filter '"/api' '"/open-webui/api';
        sub_filter '"/static' '"/open-webui/static';
        sub_filter '"/assets' '"/open-webui/assets';
        sub_filter "'/api" "'/open-webui/api";
        sub_filter "'/static" "'/open-webui/static";
        
        sub_filter_once off;

        # =========================================================
        # Config ‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô (WebSocket & Headers)
        # =========================================================
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;

        # ‡∏õ‡∏¥‡∏î Security
        proxy_hide_header X-Frame-Options;
        proxy_hide_header Content-Security-Policy;
        proxy_hide_header Content-Security-Policy-Report-Only;
    }
    
# -----------------------------------------------------------------------------------
        # ... (Block Regex ‡πÄ‡∏î‡∏¥‡∏° /proxy/... ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Service ‡∏≠‡∏∑‡πà‡∏ô‡πÜ) ...
        location ~ ^/proxy/(?<target_port>\d+)/(?<target_path>.*)$ {
            
            set $upstream_host "127.0.0.1";
            proxy_pass http://$upstream_host:$target_port/$target_path$is_args$args;

            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;

            # --- ‡∏™‡πà‡∏ß‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Path (‡πÄ‡∏î‡∏¥‡∏°) ---
            proxy_redirect ~^/(.*) /proxy/$target_port/$1;
            proxy_cookie_path / /proxy/$target_port/;

            # ==================================================
            # üî• ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°: ‡πÅ‡∏Å‡πâ‡∏õ‡∏±‡∏ç‡∏´‡∏≤ "refused to connect" üî•
            # ==================================================
            
            # 1. ‡∏•‡∏ö‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á Jupyter/Hawtio ‡∏ó‡∏¥‡πâ‡∏á‡∏ã‡∏∞
            proxy_hide_header X-Frame-Options;
            proxy_hide_header Content-Security-Policy;
            
            # 2. (Optional) ‡πÉ‡∏™‡πà Header ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ó‡∏±‡∏ö‡∏•‡∏á‡πÑ‡∏õ‡πÅ‡∏ó‡∏ô
            add_header X-Frame-Options "SAMEORIGIN";
            # ==================================================

            proxy_intercept_errors on;
            error_page 502 = @backend_down;
        }
    }
}