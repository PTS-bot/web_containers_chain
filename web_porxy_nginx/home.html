<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container Hub</title>
    <style>
        /* --- üåå Deep Space Theme --- */
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; background: #918686; }
        
        /* Header Bar */
        .header {
            height: 60px;
            background: rgba(10, 10, 15, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex; align-items: center; 
            padding: 0 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.8);
            z-index: 1000; position: relative;
        }

        .brand { 
            font-size: 1.2rem; font-weight: bold; color: white; letter-spacing: 1px; 
            text-shadow: 0 0 10px rgba(0, 210, 255, 0.5);
            margin-right: 30px;
            white-space: nowrap;
        }

        /* Menu Container */
        .nav-menu { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
            flex-grow: 1; /* ‡∏Å‡∏¥‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏±‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ó‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤ */
        }
        
        /* ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ */
        .nav-item {
            padding: 8px 20px; 
            color: #aaa; 
            text-decoration: none; 
            border-radius: 4px;
            font-size: 0.9rem; 
            transition: 0.3s; 
            cursor: pointer; 
            border: 1px solid transparent;
            background: rgba(255, 255, 255, 0.05);
            letter-spacing: 0.5px;
        }
        .nav-item:hover { 
            background: rgba(255, 255, 255, 0.1); 
            color: white; 
            border-color: rgba(255,255,255,0.2); 
        }
        
        /* Active State */
        .nav-item.active { 
            background: rgba(0, 210, 255, 0.15); 
            color: #00d2ff; 
            font-weight: bold; 
            border-color: rgba(0, 210, 255, 0.3); 
            box-shadow: 0 0 10px rgba(0, 210, 255, 0.1);
        }

        /* ‡∏õ‡∏∏‡πà‡∏° Admin Panel (Special Style) */
        .admin-btn {
            margin-left: auto; /* üî• ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏î‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á container */
            border: 1px solid rgba(255, 71, 87, 0.3);
            color: #ff6b81;
        }
        .admin-btn:hover {
            background: rgba(255, 71, 87, 0.1);
            color: #ff4757;
            border-color: #ff4757;
        }
        .admin-btn.active {
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.2);
        }

        /* User Profile */
        .user-profile { 
            display: flex; align-items: center; gap: 15px; color: white; font-size: 0.9rem; 
            padding-left: 20px; border-left: 1px solid rgba(255,255,255,0.1); margin-left: 15px;
        }
        .logout-btn {
            background: transparent; color: #aaa; border: 1px solid #444; padding: 5px 12px;
            border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: 0.2s;
        }
        .logout-btn:hover { border-color: #ff4757; color: #ff4757; }

        /* Iframe-------------------------------------------------------------------------------------------------- */
        #mainFrame {
            width: 100%; height: calc(100vh - 60px); border: none;
            background: #b9afaf;
            
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="brand">HUB OS</div> <div class="nav-menu" id="dynamicMenu">
            </div>

        <div class="user-profile">
            <span id="displayUser">User</span>
            <button class="logout-btn" onclick="logout()">Logout</button>
        </div>
    </div>

    <iframe id="mainFrame" src=""></iframe>

    <script src="menu_config.js"></script>

    <script>
        // üöÄ MAIN LOGIC
        const user = JSON.parse(sessionStorage.getItem('currentUser'));

        // 1. Check Login
        if (!user) {
            window.location.href = 'index.html';
        } else {
            document.getElementById('displayUser').innerText = user.username;
            
            if (typeof appConfig !== 'undefined') {
                renderMenu(appConfig.menus);
            } else {
                alert("Error: menu_config.js not found!");
            }
        }

        // 2. Render Menu Function
        function renderMenu(menus) {
            const menuContainer = document.getElementById('dynamicMenu');
            menuContainer.innerHTML = ''; 

            let firstAllowedUrl = '';

            // --- A. ‡∏ß‡∏ô‡∏•‡∏π‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏à‡∏≤‡∏Å Config) ---
            menus.forEach(item => {
                // ‡∏Ç‡πâ‡∏≤‡∏°‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin Panel (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏¢‡∏Å‡πÑ‡∏ß‡πâ‡∏Ç‡∏ß‡∏≤‡∏™‡∏∏‡∏î)
                if (item.id === 'manage_users') return;

                // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (DB Permissions)
                const isSuperAdmin = (user.role === 'superadmin');
                const hasPermission = (user.permissions && user.permissions.includes(item.id));
                
                if (isSuperAdmin || hasPermission) {
                    const btn = document.createElement('a');
                    btn.className = 'nav-item';
                    btn.innerText = item.name; // ‚úÖ ‡πÉ‡∏™‡πà‡πÅ‡∏Ñ‡πà‡∏ä‡∏∑‡πà‡∏≠ ‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤ Icon
                    btn.onclick = () => loadPage(item.url, btn);
                    
                    menuContainer.appendChild(btn);

                    if (!firstAllowedUrl) firstAllowedUrl = item.url;
                }
            });

            // --- B. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏õ‡∏∏‡πà‡∏° Admin Panel (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå) ---
            // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô Admin ‡∏´‡∏£‡∏∑‡∏≠ Superadmin
            if (user.role === 'admin' || user.role === 'superadmin') {
                const adminBtn = document.createElement('a');
                adminBtn.className = 'nav-item admin-btn'; // ‡πÄ‡∏û‡∏¥‡πà‡∏° class admin-btn ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏±‡∏ô‡πÑ‡∏õ‡∏Ç‡∏ß‡∏≤
                adminBtn.innerText = 'Admin Panel';
                adminBtn.onclick = () => loadPage('admin-view.html', adminBtn); // ‡πÑ‡∏ü‡∏•‡πå Admin ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì
                
                menuContainer.appendChild(adminBtn);

                // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏•‡∏¢ ‡∏Å‡πá‡πÄ‡∏õ‡∏¥‡∏î Admin ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å
                if (!firstAllowedUrl) firstAllowedUrl = 'admin-view.html';
            }

            // --- C. ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ ---
            if (firstAllowedUrl) {
                // ‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö url ‡πÅ‡∏£‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠ set active
                // (‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢‡πÜ ‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏•‡∏¢ ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÑ‡∏õ‡πÑ‡∏•‡πà set active ‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á)
                const allBtns = menuContainer.querySelectorAll('.nav-item');
                if (allBtns.length > 0) {
                    // ‡∏ñ‡πâ‡∏≤‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏£‡∏Å‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà Admin ‡πÉ‡∏´‡πâ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏õ‡∏∏‡πà‡∏°‡πÅ‡∏£‡∏Å
                    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÅ‡∏ï‡πà Admin ‡∏Å‡πá‡∏Ñ‡∏•‡∏¥‡∏Å Admin
                    if(allBtns[0].innerText !== 'Admin Panel' || allBtns.length === 1) {
                         allBtns[0].click();
                    } else {
                        // ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° Admin ‡∏≠‡∏¢‡∏π‡πà‡∏Ç‡∏ß‡∏≤‡∏™‡∏∏‡∏î ‡πÅ‡∏ï‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏°‡∏±‡∏ô Active ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô
                        loadPage(firstAllowedUrl, null); 
                        // ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏£‡∏≤ create element ‡πÅ‡∏ö‡∏ö dynamic ‡∏Å‡∏≤‡∏£‡∏´‡∏≤ element ‡πÄ‡∏û‡∏∑‡πà‡∏≠ add class active ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏¢‡∏≤‡∏Å
                        // ‡πÉ‡∏´‡πâ user ‡∏Å‡∏î‡πÄ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠ set default ‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô
                    }
                }
            } else {
                document.getElementById('mainFrame').src = 'about:blank';
            }
        }

        function loadPage(url, el) {
            document.getElementById('mainFrame').src = url;
            
            // Toggle Active Class
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            if(el) el.classList.add('active');
        }

        function logout() {
            sessionStorage.clear();
            fetch('/api/logout', { method: 'POST' }).catch(e => console.log(e));
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>